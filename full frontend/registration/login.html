<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login</title>
    <link rel="stylesheet" href="/static/css/registration/login.css">
</head>
<body>

    <div id="navbar-container"></div>

    <div class="login_section">
        <form method="post" id="loginForm">
            <h1>Login</h1>

            <button class="google-btn" type="button">
                <img src="https://www.svgrepo.com/show/355037/google.svg" alt="Google" />
                Continue with Google
            </button>

            <button class="github-btn" type="button">
                <img src="https://www.svgrepo.com/show/512317/github-142.svg" alt="Github" />
                Continue with Github
            </button>

            <input type="text" name="username" placeholder="Username" id="username" required>
            <input type="password" name="password" placeholder="Password" id="password" required>

            <button class="login-btn" type="submit">Login</button>

            <p class="create-account">
                Don't have an account? 
                <a href="/registration/register.html">Create account</a>
            </p>
        </form>
    </div>

    <script>
        // ðŸ”¹ Load navbar and apply login/logout logic
        async function loadNavbar() {
            try {
                const response = await fetch('/templates/navbar.html');
                if (!response.ok) throw new Error("Failed to load navbar");

                const html = await response.text();
                document.getElementById('navbar-container').innerHTML = html;

                const loginSignupContainer = document.querySelector(".login_signup_links");
                if (!loginSignupContainer) return;

                // Check tokens (support both camelCase + snake_case just in case)
                const token = localStorage.getItem("accessToken") || localStorage.getItem("access_token");

                if (token) {
                    loginSignupContainer.innerHTML = `
                        <a href="#" class="nav-link" id="logout-link">Logout</a>
                    `;
                    document.getElementById("logout-link").addEventListener("click", (e) => {
                        e.preventDefault();
                        localStorage.removeItem("accessToken");
                        localStorage.removeItem("refreshToken");
                        localStorage.removeItem("access_token");
                        localStorage.removeItem("refresh_token");
                        window.location.href = "/templates/stt.html";
                    });
                }
            } catch (error) {
                console.error("Error loading navbar:", error);
            }
        }
        loadNavbar();

        document.getElementById("loginForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            const data = {
                username: document.getElementById("username").value,
                password: document.getElementById("password").value
            };

            try {
                const response = await fetch("http://127.0.0.1:8000/users/login/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok) {
                    const access = result.access || result.access_token;
                    const refresh = result.refresh || result.refresh_token;

                    localStorage.setItem("accessToken", access);
                    localStorage.setItem("refreshToken", refresh);

                    localStorage.removeItem("access_token");
                    localStorage.removeItem("refresh_token");

                    window.location.href = "/templates/home.html";
                } else {
                    alert(result.detail || "Username or password incorrect!");
                }
            } catch (error) {
                alert("Server error: " + error);
            }
        });
    </script>
</body>
</html>
